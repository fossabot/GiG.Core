<html>

<head>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" href="./site.css" />
	<script src="./libs/signalr.min.js"></script>
</head>

<body>
	<div class="system-tab-container">
		<div class="system-tab active">
			<div class="system-tab-header">
				<button class="system-tab-close"></button>
				<ol class="breadcrumb">
					<li class="breadcrumb-item">Account</li>
				</ol>
				<h2 class="system-tab-title">
					John Rory Smith
				</h2>
			</div>
			<div class="system-tab-body">
				<div class="container-fluid">
					<div class="row justify-content-center">
						<div class="col-md-8 col-lg-6 col-xl-4">
							<div class="row">
								<div class="col">
									<div class="d-flex">
										<label class="mr-auto">Your Balance</label>
										<h2>&euro; <span class="code" balance>-</span></h2>
									</div>
								</div>
							</div>

							<div class="row">
								<div class="col">
									<div class="nav nav-tabs mb-4">
										<div class="nav-item">
											<button class="nav-link">Account</button>
										</div>
										<div class="nav-item">
											<button class="nav-link active">Deposit</button>
										</div>
										<div class="nav-item">
											<button class="nav-link">Withdraw</button>
										</div>
									</div>
								</div>
							</div>

							<div data-tab="account" class="d-none animate-children">
								<div class="card">
									<div class="card-body">
										<dl>
											<dt>First Name</dt>
											<dd>John Rory</dd>
											<dt>Last Name</dt>
											<dd>Smith</dd>
											<dt>Email</dt>
											<dd>jrsmth@mailman.org</dd>
											<dt>Address 1</dt>
											<dd>17 Bramall Lane</dd>
											<dt>Address 2</dt>
											<dd>-</dd>
											<dt>City</dt>
											<dd>Sheffield</dd>
											<dt>ZIP</dt>
											<dd>S2 4SU</dd>
											<dt>Country</dt>
											<dd><i class="gigflag gigflag-united-kingdom mt-2"></i> United Kingdom</dd>
										</dl>
									</div>
								</div>

								<button class="btn btn-link btn-block">Edit Details</button>
							</div>

							<div data-tab="deposit" class="animate-children">
								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<span class="badge icon-badge bg-blue mr-3">
												<i class="uil uil-wallet"></i>
											</span>
											<h4>
												Deposit
											</h4>
										</div>
									</div>
								</div>

								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<h4 class="mr-3">EUR</h4>
											<input type="number" id="deposit" class="form-control" placeholder="0"
												autofocus amount>
										</div>
										<div class="mt-3 d-flex justify-content-between">
											<a href="#" suggestion>&euro; 10</a>
											<a href="#" suggestion>&euro; 25</a>
											<a href="#" suggestion>&euro; 50</a>
											<a href="#" suggestion>&euro; 100</a>
											<a href="#" suggestion>&euro; 250</a>
											<a href="#" suggestion>&euro; 500</a>
										</div>
									</div>
								</div>

								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<label class="mr-3">Deposit From</label>
											<div class="dropdown">
												<input type="text" class="form-control form-control-sm" readonly
													value="Mastercard 0123">
											</div>
										</div>
									</div>
								</div>

								<div class="row justify-content-center">
									<div class="col-8">
										<button class="btn btn-primary btn-block"
											onclick="deposit(this)">Deposit</button>
									</div>
								</div>
							</div>

							<div data-tab="withdraw" class="d-none animate-children">
								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<span class="badge icon-badge bg-white text-blue mr-3">
												<i class="uil uil-wallet"></i>
											</span>
											<h4>
												Withdraw
											</h4>
										</div>
									</div>
								</div>

								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<h4 class="mr-3">EUR</h4>
											<input type="number" id="withdraw" class="form-control" placeholder="0"
												autofocus amount>
										</div>

										<span class="form-text">
											&euro; <span balance></span> available to withdraw
										</span>
									</div>
								</div>

								<div class="row">
									<div class="col">
										<div class="d-flex align-items-baseline">
											<label class="mr-3">Withdraw To</label>
											<div class="dropdown">
												<input type="text" class="form-control form-control-sm" readonly
													value="Mastercard 0123">
											</div>
										</div>
									</div>
								</div>

								<div class="row justify-content-center">
									<div class="col-8">
										<button class="btn btn-secondary btn-block" onclick="withdrawal(this)">Review
											and Withdraw</button>
									</div>
								</div>
							</div>

							<div data-tab="success" class="d-none animate-children">
								<div class="text-center">
									<img src="https://gig-ui-kit-next.netlify.com/assets/core/misc/check-large.svg"
										alt="">
								</div>

								<div class="text-center">
									<h3>
										Success!
									</h3>
								</div>

								<div class="text-center">
									<div class="btn btn-sm btn-link mt-3" onclick="activateTab()">
										<i class="uil uil-arrow-left"></i> Go Back
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="notifications-container">

	</div>
</body>

</html>

<script type="text/javascript">
	const notificationsBaseUrl = "/notifications";
	const paymentsBaseUrl = "/payments";
	const walletsBaseUrl = "/wallets";
	const headers = new Headers({ 'Player-ID': getPlayerId(), 'Content-Type': 'application/json', 'Accept': 'application/json' })

	function startConnection() {
		connection.start().then(function () {
			console.log("Signal r connected");
			subscribeBalanceNotification();
		}).catch();
	}
	
	var connection = new signalR.HubConnectionBuilder()
		.withUrl(`${notificationsBaseUrl}/open`)
		.withAutomaticReconnect()
		.configureLogging(signalR.LogLevel.Error)
		.build();
		
	connection.on('BalanceChanged', updateBalance);

	function getBalance() {
		fetch(`${walletsBaseUrl}/balance`, { headers })
			.then(response => response.json().then(
				data => {
					updateBalance(data);
				}
			));
	}

	function withdrawal(element) {
		var amount = parseInt(document.getElementById("withdraw").value);

		fetch(`${paymentsBaseUrl}/withdraw`, {
			method: "POST",
			headers: headers,
			body: JSON.stringify({
				amount
			})
		}).then(response => {
			return response.json().then(data => {
				if (response.ok) {
					loadSuccess(element, data);
				}
				else {
					showError(data);
				}
			})
		});
	}

	function deposit(element) {
		var amount = parseInt(document.getElementById("deposit").value);

		fetch(`${paymentsBaseUrl}/deposit`, {
			method: "POST",
			headers: headers,
			body: JSON.stringify({
				amount
			})
		}).then(response => {
			response.json().then(data => {
				if (response.ok) {
					loadSuccess(element, data);
				}
				else {
					showError(data);
				}
			});
		})
	}

	function startupScript() {
		for (suggestion of document.querySelectorAll("[suggestion]")) {
			suggestion.addEventListener("click", setValue);
		}

		for (tab of document.querySelectorAll(".nav-tabs .nav-link")) {
			tab.addEventListener("click", activateTab);
		}

		for (submit of document.querySelectorAll("[submit]")) {
			submit.addEventListener("click", loadSuccess);
		}

		getBalance();

		startConnection();
	};

	function subscribeBalanceNotification() {
		connection.invoke("SubscribeAsync", getPlayerId());
	}

	function getTextField() {
		return document.querySelector("div:not(.d-none) [amount]");
	}

	function activateTab(event) {
		var tab = event ? event.target : document.querySelector(".nav-tabs .active");
		tab.parentElement.parentElement.querySelector(".active").classList.remove("active");

		tab.classList.add("active");

		showTab(tab.innerText.toLowerCase().trim());
	}

	function showTab(tabName) {
		for (view of document.querySelectorAll("[data-tab]")) {
			view.classList.toggle("d-none", view.dataset.tab !== tabName);
		}
	}

	function loadSuccess(element, data) {
		element.classList.add("loading");
		setTimeout(function (button) {
			button.classList.remove("loading");
			showTab("success");

		}, 200, element);
	}

	function setValue(event) {
		getTextField().value = event.target.innerText.replace(/\D/g, "");
		getTextField().focus();
	}

	function showError(error) {
		document.getElementsByClassName("notifications-container")[0].innerHTML =
			`<div class="alert alert-danger">
            <button class="close" onclick="closeNotification(this)"></button>
            ${error}
        </div>`;
	}

	function closeNotification(element) {
		element.parentElement.remove();
	}

	function updateBalance(balance) {
		for (balanceElement of document.querySelectorAll("[balance]")) {
			balanceElement.innerHTML = balance.toFixed(2);
		}
	}

	var playerId;

	function getPlayerId() {
		if (playerId == null) {
			playerId = generatePlayerId();
		}

		return playerId;
	}

	function generatePlayerId() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
			var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
	}

	startupScript();	
</script>